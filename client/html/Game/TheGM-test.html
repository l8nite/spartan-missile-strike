<html>
	<head>
		<title>TheGM Test</title>
		<link rel="stylesheet" href="../qunit/qunit.css">
	</head>
	<body>
		<div id="qunit"></div>
		<div id="qunit-fixture"></div>
		<script src="../qunit/qunit.js"></script>
		<script src="../jquery/jquery.js"></script>
		<script src="TheGM.js"></script>
		<script>
			// asyncTest("Resume game", 1, function () {
			// 	var NativeBridge = new NativeBridge_Abstract();
			// 	NativeBridge.setResumeHandler(function (){
			// 		ok(true, "Resume handler successfully registered and called");
			// 		start();
			// 	});
			// 	NativeBridge.resumeGame();
			// });
			function arrEqual(a, b) {
				if (a.length !== b.length) {
					return false;
				}
				for (var i in a) {
					if (a[i] !== b[i]) {
						return false;
					}
				}
				return true;
			}

			function datesClose(a, b, expectedDelta, skew) {
				var dt = b.getTime() - a.getTime();
				return (dt >= expectedDelta - skew && dt <= expectedDelta + skew);
			}

			asyncTest("Many callbacks, service dropouts, stop poll at end", 14, function () {
				var thegm = new TheGM("fake-user", "fake-session-id");
				// Since the service doesn't work yet, we need to reappropriate _getGamesFromService. It returns a jQuery deferred and resolves with a games datastructure.
				var timescalled = 0;
				thegm._getGamesFromService = function () {
					var d = $.Deferred();
					var thistime = timescalled++;
					setTimeout(function () {
						if (thistime === 0) {
							d.resolve(["g0"]);
						}
						else if (thistime === 1) {
							d.resolve(["g0", "g1"]);
						}
						else if (thistime >= 2 && thistime < 5 ) {
							d.reject();
						}
						else if (thistime === 5) {
							d.resolve(["g1", "g2", "g3"]);
						}
						else {
							d.resolve(["g2", "g3", "g4"]);
						}
					}, Math.random * 500);
					return d;
				};

				thegm._STALE = 500;

				// Callback identifiers
				var cb0, cb1, cb2;
				var c0, c1, c2;

				function f0(games) {
					if (c0 === 0) {
						ok(arrEqual(games, []), "CB0 0");
					}
					else if (c0 === 1) {
						ok(arrEqual(games, ["g0"]), "CB0 1");
					}
					else if (c0 === 2) {
						ok(arrEqual(games, ["g0", "g1"]), "CB0 2");
						c1 = c0;
						cb1 = thegm.subscribe(f1);
					}
					else if (c0 === 3) {
						ok(arrEqual(games, ["g1", "g2", "g3"]), "CB0 3");
					}
					else if (c0 === 4) {
						ok(arrEqual(games, ["g2", "g3", "g4"]), "CB0 4");
						c2 = c0;
						cb2 = thegm.subscribe(f2);
					}
					else if (c0 === 5) {
						ok(arrEqual(games, ["g2", "g3", "g4"]), "CB0 5");
					}
					else if (c0 === 6) {
						thegm.unsubscribe(cb0);
						thegm.unsubscribe(cb1);
						thegm.unsubscribe(cb2);
						ok(thegm._listeners.holes.length === thegm._listeners.listeners.length, "All callbacks deleted");
						ok(!thegm._poll, "No longer polling service for games");
						start();
					}
					c0++;
				}

				function f1(games) {
					if (c1 === 2) {
						ok(arrEqual(games, ["g0", "g1"]), "CB1 2");
					}
					else if (c1 === 3) {
						ok(arrEqual(games, ["g1", "g2", "g3"]), "CB1 3");
					}
					else if (c1 === 4) {
						ok(arrEqual(games, ["g2", "g3", "g4"]), "CB1 4");
					}
					else if (c1 === 5) {
						ok(arrEqual(games, ["g2", "g3", "g4"]), "CB1 5");
					}
					c1++;
				}

				function f2(games) {
					if (c2 === 4) {
						ok(arrEqual(games, ["g2", "g3", "g4"]), "CB2 4");
					}
					else if (c2 === 5) {
						ok(arrEqual(games, ["g2", "g3", "g4"]), "CB2 5");
					}
					c2++;
				}

				c0 = 0;
				cb0 = thegm.subscribe(f0);
			});

			var serviceLatency = 500;
			asyncTest("Many callbacks, stop poll during test and immediately resume", 13, function () {
				var thegm = new TheGM("fake-user", "fake-session-id");
				var timescalled = 0;
				thegm._getGamesFromService = function () {
					var d = $.Deferred();
					setTimeout(function () {
						if (timescalled >= 0 && timescalled < 2) {
							d.resolve(["g0"]);
						}
						else {
							d.resolve(["g0", "g1"]);
						}
						timescalled++;
					}, serviceLatency);
					return d;
				};

				thegm._STALE = 1000;

				var cb0, cb1;
				var c0, c1;
				var stash_t0, stash_t1;

				function f0(games) {
					if (c0 === 0) {
						c0++;
						ok(games.length === 0, "CB0 0");
						stash_t0 = new Date();
					}
					else if (c0 === 1) {
						c0++;
						ok(arrEqual(games, ["g0"]), "CB0 1");
						var d = new Date();
						ok(datesClose(stash_t0, d, serviceLatency, 5), "CB0 1 time");
						stash_t0 = d;
					}
					else if (c0 === 2) {
						c0++;
						ok(arrEqual(games, ["g0"]), "CB0 2");
						var d = new Date();
						ok(datesClose(stash_t0, d, thegm._STALE + serviceLatency, 5), "CB0 2 time");
						stash_t0 = d;
						thegm.unsubscribe(cb0);
						ok(thegm._listeners.holes.length === thegm._listeners.listeners.length, "Listeners is empty");
						ok(!thegm._poll, "No longer polling service");
						console.log(thegm);
						cb0 = thegm.subscribe(f0);
						console.log(cb0);
					}
					else if (c0 === 3) {
						c0++;
						ok(arrEqual(games, ["g0"]), "CB0 3");
						var d = new Date();
						ok(datesClose(stash_t0, d, 0, 5), "CB0 3 time");
						stash_t0 = d;
					}
					else if (c0 === 4) {
						c0++;
						ok(arrEqual(games, ["g0", "g1"]), "CB0 4");
						var d = new Date();
						ok(datesClose(stash_t0, d, thegm._STALE + serviceLatency, 5), "CB0 4 time");
						stash_t0 = d;
						thegm.unsubscribe(cb0);
						ok(thegm._listeners.holes.length === thegm._listeners.listeners.length, "Listeners is empty");
						ok(!thegm._poll, "No longer polling service");
						console.log(thegm);
						start();
					}
				}

				function f1(games) {
					c1++;
				}

				c0 = 0;
				cb0 = thegm.subscribe(f0);
				console.log(thegm);
			});
		</script>
	</body>
</html>